# This workflow rebases develop into main or pre-release directly (no PR, no squash, no merge commits).
#
# Automatic mode:
# - Triggers when a PR is merged to develop and checks if the PR title
#   contains [release] or [prerelease] tags (added by the bump-version.yml workflow).
# - If found, rebases develop onto the appropriate branch (main or pre-release).
#
# Manual mode:
# - Run this workflow manually from GitHub Actions
# - Select release type (release or prerelease)
# - Rebases develop onto the appropriate branch
#
# This workflow works in conjunction with bump-version.yml to provide a streamlined
# release process.

name: Merge to Release Branch

on:
  pull_request:
    types: [closed]
    branches:
      - develop
  workflow_dispatch:
    inputs:
      release_type:
        description: "Release type"
        required: true
        type: choice
        options:
          - release
          - prerelease

permissions:
  contents: write

jobs:
  merge_to_release:
    # For PR events: only run if the PR was actually merged (not just closed)
    # For workflow_dispatch: always run
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_GITHUB }}

      - name: Determine release type
        id: release-type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ inputs.release_type }}" >> "$GITHUB_OUTPUT"
            echo "Manual trigger with release type: ${{ inputs.release_type }}"
          else
            PR_TITLE="${{ github.event.pull_request.title }}"
            echo "PR title: $PR_TITLE"
            if echo "$PR_TITLE" | grep -q '\[release\]'; then
              echo "type=release" >> "$GITHUB_OUTPUT"
              echo "Detected release type: release"
            elif echo "$PR_TITLE" | grep -q '\[prerelease\]'; then
              echo "type=prerelease" >> "$GITHUB_OUTPUT"
              echo "Detected release type: prerelease"
            else
              echo "type=none" >> "$GITHUB_OUTPUT"
              echo "No release type found in PR title, skipping."
            fi
          fi

      - name: Rebase develop into target branch
        if: steps.release-type.outputs.type != 'none'
        run: |
          RELEASE_TYPE="${{ steps.release-type.outputs.type }}"
          if [ "$RELEASE_TYPE" = "release" ]; then
            TARGET_BRANCH="main"
          else
            TARGET_BRANCH="pre-release"
          fi

          VERSION=$(jq -r '.version' package.json)
          echo "Rebasing develop into ${TARGET_BRANCH} (version ${VERSION})"

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git checkout "${TARGET_BRANCH}"
          git rebase origin/develop
          git push --force-with-lease origin "${TARGET_BRANCH}"

          echo "Successfully rebased develop into ${TARGET_BRANCH}"
